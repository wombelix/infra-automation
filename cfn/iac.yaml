# SPDX-FileCopyrightText: 2025 Dominik Wombacher <dominik@wombacher.cc>
#
# SPDX-License-Identifier: Apache-2.0

AWSTemplateFormatVersion: 2010-09-09
Description: Infrastructure as Code (IaC) resources

Parameters:
  OrganizationId:
    Type: String
    Description: AWS Organizations ID for cross-account access control
    AllowedPattern: '^o-[a-z0-9]{10,32}$'
    ConstraintDescription: Must be a valid AWS Organizations ID (e.g., o-exampleorgid)
  KMSStackName:
    Type: String
    Description: Name of the KMS stack that exports the backend encryption key ARN
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9-]*$'
    ConstraintDescription: Must be a valid CloudFormation stack name (alphanumeric and hyphens, starting with a letter)
  OpenTofuRemoteBackendBucketName:
    Type: String
    Description: Name of the primary OpenTofu remote backend S3 bucket
    AllowedPattern: '^[a-z0-9][a-z0-9.-]{1,61}[a-z0-9]$'
    ConstraintDescription: Must be a valid S3 bucket name (3-63 lowercase alphanumeric characters, hyphens, periods)
  OpenTofuRemoteBackendBucketNameReplica:
    Type: String
    Description: Name of the replica OpenTofu remote backend S3 bucket
    AllowedPattern: '^[a-z0-9][a-z0-9.-]{1,61}[a-z0-9]$'
    ConstraintDescription: Must be a valid S3 bucket name (3-63 lowercase alphanumeric characters, hyphens, periods)
  OpenTofuRemoteBackendReplicationRoleName:
    Type: String
    Description: Name of the IAM role for S3 cross-region replication
    AllowedPattern: '^[a-zA-Z0-9+=,.@_-]+$'
    ConstraintDescription: Must be a valid IAM role name (alphanumeric and +=,.@_- characters)
  OpenTofuRemoteBackendDDBTableName:
    Type: String
    Description: Name of the DynamoDB table for OpenTofu state locking
    AllowedPattern: '^[a-zA-Z0-9._-]+$'
    ConstraintDescription: Must be a valid DynamoDB table name (alphanumeric, hyphens, underscores, periods)
  OpenTofuRemoteBackendRoleName:
    Type: String
    Description: Name of the IAM role for OpenTofu remote backend access
    AllowedPattern: '^[a-zA-Z0-9+=,.@_-]+$'
    ConstraintDescription: Must be a valid IAM role name (alphanumeric and +=,.@_- characters)
  GitRepoMgmtRoleName:
    Type: String
    Description: Name of the IAM role for git-repo-mgmt to create backend access roles
    AllowedPattern: '^[a-zA-Z0-9+=,.@_-]+$'
    ConstraintDescription: Must be a valid IAM role name (alphanumeric and +=,.@_- characters)
  OpenTofuStateEncryptionRoleName:
    Type: String
    Description: Name of the IAM role for OpenTofu state encryption (KMS access)
    AllowedPattern: '^[a-zA-Z0-9+=,.@_-]+$'
    ConstraintDescription: Must be a valid IAM role name (alphanumeric and +=,.@_- characters)
  ReplicaRegion:
    Type: String
    Description: AWS region for the replica resources
    AllowedPattern: '^[a-z0-9-]+$'
    ConstraintDescription: Must be a valid AWS region name

Resources:
  # https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 7560D6F40FA55195F740EE2B1B7C0B4836CBE103

  OpenTofuRemoteBackendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref OpenTofuRemoteBackendBucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID:
                Fn::ImportValue:
                  !Sub ${KMSStackName}-KMSKeyBackendEncryptionArn
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: TransitionsForStateFile
            Status: Enabled
            Transitions:
              - TransitionInDays: 7
                StorageClass: INTELLIGENT_TIERING
            NoncurrentVersionTransitions:
              - TransitionInDays: 1
                StorageClass: GLACIER
      VersioningConfiguration:
        Status: Enabled
      ReplicationConfiguration:
        Role: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${OpenTofuRemoteBackendReplicationRoleName}
        Rules:
          - Id: ReplicateOpenTofuStates
            Status: Enabled
            Prefix: opentofu-states/
            SourceSelectionCriteria:
              SseKmsEncryptedObjects:
                Status: Enabled
            Destination:
              Bucket: !Sub arn:${AWS::Partition}:s3:::${OpenTofuRemoteBackendBucketNameReplica}
              StorageClass: STANDARD
              EncryptionConfiguration:
                ReplicaKmsKeyID: !Sub
                  - arn:${AWS::Partition}:kms:${ReplicaRegion}:${AWS::AccountId}:key/${KMSKeyId}
                  - KMSKeyId:
                      Fn::ImportValue:
                        !Sub ${KMSStackName}-KMSKeyBackendEncryptionName
      LoggingConfiguration:
        LogFilePrefix: 'opentofu-logs/'
      Tags:
        - Key: "Environment"
          Value: "Production"
        - Key: "Usage"
          Value: "IAC-OpenTofu"
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  OpenTofuRemoteBackendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref OpenTofuRemoteBackendBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyDeletingOpenTofuStateFiles
            Effect: Deny
            Principal: "*"
            Action: "s3:DeleteObject"
            Resource:
              - !Sub "${OpenTofuRemoteBackendBucket.Arn}/*"
          - Sid: AllowS3LogDelivery
            Effect: Allow
            Principal:
              Service: logging.s3.amazonaws.com
            Action: s3:PutObject
            Resource:
              - !Sub "${OpenTofuRemoteBackendBucket.Arn}/opentofu-logs/*"
            Condition:
              ArnLike:
                aws:SourceArn: !GetAtt OpenTofuRemoteBackendBucket.Arn
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
          - Sid: RestrictToTLSRequestsOnly
            Principal: "*"
            Action: "s3:*"
            Effect: Deny
            Resource:
              - !GetAtt OpenTofuRemoteBackendBucket.Arn
              - !Sub "${OpenTofuRemoteBackendBucket.Arn}/*"
            Condition:
              Bool:
                "aws:SecureTransport": "false"
          # Organization-wide backend access for matching roles
          # Path restrictions are enforced by the roles attached policies
          - Sid: AllowOrganizationListBucket
            Effect: Allow
            Principal: "*"
            Action:
              - s3:ListBucket
            Resource:
              - !GetAtt OpenTofuRemoteBackendBucket.Arn
            Condition:
              StringEquals:
                aws:PrincipalOrgID: !Ref OrganizationId
              ArnLike:
                aws:PrincipalArn:
                  - !Sub "arn:${AWS::Partition}:iam::*:role/OpenTofuRemoteBackendAccessRole"
                  - !Sub "arn:${AWS::Partition}:iam::*:role/GitHubOIDC-*-OpenTofuBackendAccess"
          - Sid: AllowOrganizationStateAccess
            Effect: Allow
            Principal: "*"
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource:
              - !Sub "${OpenTofuRemoteBackendBucket.Arn}/opentofu-states/*"
            Condition:
              StringEquals:
                aws:PrincipalOrgID: !Ref OrganizationId
              ArnLike:
                aws:PrincipalArn:
                  - !Sub "arn:${AWS::Partition}:iam::*:role/OpenTofuRemoteBackendAccessRole"
                  - !Sub "arn:${AWS::Partition}:iam::*:role/GitHubOIDC-*-OpenTofuBackendAccess"

  # Temporary state file locking, doesn't contain critical data, also no PIT recovery necessary
  OpenTofuRemoteBackendDDB:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Ref OpenTofuRemoteBackendDDBTableName
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: LockID
          AttributeType: S
      KeySchema:
        - AttributeName: LockID
          KeyType: HASH
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId:
          Fn::ImportValue:
            !Sub ${KMSStackName}-KMSKeyBackendEncryptionArn
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false
      ResourcePolicy:
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Sid: AllowOrganizationAccess
              Effect: Allow
              Principal: "*"
              Action:
                - dynamodb:DescribeTable
                - dynamodb:GetItem
                - dynamodb:PutItem
                - dynamodb:DeleteItem
              Resource: "*"
              Condition:
                StringEquals:
                  aws:PrincipalOrgID: !Ref OrganizationId
                ArnLike:
                  aws:PrincipalArn:
                    - !Sub "arn:${AWS::Partition}:iam::*:role/OpenTofuRemoteBackendAccessRole"
                    - !Sub "arn:${AWS::Partition}:iam::*:role/GitHubOIDC-*-OpenTofuBackendAccess"
      Tags:
        - Key: "Environment"
          Value: "Production"
        - Key: "Usage"
          Value: "IAC-OpenTofu"
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain

  OpenTofuRemoteBackendRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref OpenTofuRemoteBackendRoleName
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
                token.actions.githubusercontent.com:sub: repo:wombelix/infra-automation:ref:refs/heads/main
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
            Action: sts:AssumeRole
            Condition:
              ArnLike:
                aws:PrincipalArn: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-reserved/sso.amazonaws.com/*/AWSReservedSSO_AdministratorAccess_*"

  OpenTofuRemoteBackendRolePolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      RoleName: !Ref OpenTofuRemoteBackendRole
      PolicyName: OpenTofuRemoteBackendPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: 's3:ListBucket'
            Resource:
              - !GetAtt OpenTofuRemoteBackendBucket.Arn
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource:
              - !Sub "${OpenTofuRemoteBackendBucket.Arn}/opentofu-states/*"
          - Effect: Allow
            Action:
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
            Resource:
              - !GetAtt OpenTofuRemoteBackendDDB.Arn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - Fn::ImportValue:
                  !Sub ${KMSStackName}-KMSKeyBackendEncryptionArn

  OpenTofuStateEncryptionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref OpenTofuStateEncryptionRoleName
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
                token.actions.githubusercontent.com:sub: repo:wombelix/infra-automation:ref:refs/heads/main
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
            Action: sts:AssumeRole
            Condition:
              ArnLike:
                aws:PrincipalArn: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-reserved/sso.amazonaws.com/*/AWSReservedSSO_AdministratorAccess_*"

  OpenTofuStateEncryptionRolePolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      RoleName: !Ref OpenTofuStateEncryptionRole
      PolicyName: OpenTofuStateEncryptionPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - Fn::ImportValue:
                  !Sub ${KMSStackName}-KMSKeyBackendEncryptionArn

  # Permission boundary for roles created by git-repo-mgmt
  # Roles created with this boundary can ONLY access OpenTofu backend resources
  GitRepoMgmtPermissionBoundary:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: GitRepoMgmtPermissionBoundary
      Description: Permission boundary for roles created by git-repo-mgmt - limits to backend access only
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Only allow S3 access to the backend bucket, opentofu-states prefix
          - Sid: S3BackendAccess
            Effect: Allow
            Action:
              - s3:ListBucket
              - s3:GetObject
              - s3:PutObject
            Resource:
              - !GetAtt OpenTofuRemoteBackendBucket.Arn
              - !Sub "${OpenTofuRemoteBackendBucket.Arn}/opentofu-states/*"
          # Only allow DynamoDB access to the lock table
          - Sid: DynamoDBLockAccess
            Effect: Allow
            Action:
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
            Resource:
              - !GetAtt OpenTofuRemoteBackendDDB.Arn
          # Only allow KMS access to the backend encryption key
          - Sid: KMSBackendAccess
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
            Resource:
              - Fn::ImportValue:
                  !Sub ${KMSStackName}-KMSKeyBackendEncryptionArn

  # Role for git-repo-mgmt to create other OpenTofu backend access roles
  # Can only create roles matching GitHubOIDC-*-OpenTofuBackendAccess pattern
  GitRepoMgmtRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref GitRepoMgmtRoleName
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
                token.actions.githubusercontent.com:sub: repo:wombelix/git-repo-mgmt:ref:refs/heads/main
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:root"
            Action: sts:AssumeRole
            Condition:
              ArnLike:
                aws:PrincipalArn: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/aws-reserved/sso.amazonaws.com/*/AWSReservedSSO_AdministratorAccess_*"

  GitRepoMgmtRolePolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      RoleName: !Ref GitRepoMgmtRole
      PolicyName: GitRepoMgmtPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow creating/managing roles ONLY with specific naming pattern AND permission boundary
          # iam:PermissionsBoundary condition enforces that created roles MUST have the boundary
          - Sid: CreateBackendAccessRoles
            Effect: Allow
            Action:
              - iam:CreateRole
              - iam:TagRole
              - iam:UntagRole
              - iam:ListRoleTags
              - iam:GetRole
            Resource:
              - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/GitHubOIDC-*-OpenTofuBackendAccess"
            Condition:
              StringEquals:
                "iam:PermissionsBoundary": !Ref GitRepoMgmtPermissionBoundary
          # Allow deleting roles only if they have the permission boundary
          # This prevents deleting roles that don't belong to git-repo-mgmt
          - Sid: DeleteBackendAccessRoles
            Effect: Allow
            Action:
              - iam:DeleteRole
            Resource:
              - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/GitHubOIDC-*-OpenTofuBackendAccess"
            Condition:
              StringEquals:
                "iam:PermissionsBoundary": !Ref GitRepoMgmtPermissionBoundary
          # Allow managing inline policies on the allowed roles (with boundary check)
          - Sid: ManageBackendAccessRolePolicies
            Effect: Allow
            Action:
              - iam:PutRolePolicy
              - iam:DeleteRolePolicy
              - iam:GetRolePolicy
              - iam:ListRolePolicies
            Resource:
              - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/GitHubOIDC-*-OpenTofuBackendAccess"
            Condition:
              StringEquals:
                "iam:PermissionsBoundary": !Ref GitRepoMgmtPermissionBoundary
          # Explicitly deny removing permission boundaries - prevents privilege escalation
          - Sid: DenyRemovingPermissionBoundary
            Effect: Deny
            Action:
              - iam:DeleteRolePermissionsBoundary
              - iam:PutRolePermissionsBoundary
            Resource: "*"
          # Explicitly deny modifying the permission boundary policy itself
          - Sid: DenyModifyingBoundaryPolicy
            Effect: Deny
            Action:
              - iam:CreatePolicyVersion
              - iam:DeletePolicy
              - iam:DeletePolicyVersion
              - iam:SetDefaultPolicyVersion
            Resource:
              - !Ref GitRepoMgmtPermissionBoundary
          # Allow reading the OIDC provider (needed to reference in trust policies)
          - Sid: ReadOIDCProvider
            Effect: Allow
            Action:
              - iam:GetOpenIDConnectProvider
            Resource:
              - !GetAtt GitHubOIDCProvider.Arn
          # Allow reading the permission boundary (needed to verify/attach it)
          - Sid: ReadPermissionBoundary
            Effect: Allow
            Action:
              - iam:GetPolicy
              - iam:GetPolicyVersion
            Resource:
              - !Ref GitRepoMgmtPermissionBoundary
          # Backend access for git-repo-mgmt own state file
          - Sid: S3ListBucket
            Effect: Allow
            Action: s3:ListBucket
            Resource:
              - !GetAtt OpenTofuRemoteBackendBucket.Arn
          - Sid: S3StateAccess
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource:
              - !Sub "${OpenTofuRemoteBackendBucket.Arn}/opentofu-states/git-repo-mgmt/*"
          - Sid: DynamoDBLocking
            Effect: Allow
            Action:
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
            Resource:
              - !GetAtt OpenTofuRemoteBackendDDB.Arn
          - Sid: KMSAccess
            Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - Fn::ImportValue:
                  !Sub ${KMSStackName}-KMSKeyBackendEncryptionArn

Outputs:
  OpenTofuRemoteBackendBucketName:
    Value: !Ref OpenTofuRemoteBackendBucket
    Export:
      Name: !Sub ${AWS::StackName}-OpenTofuRemoteBackendBucketName

  OpenTofuRemoteBackendBucketArn:
    Value: !GetAtt OpenTofuRemoteBackendBucket.Arn
    Export:
      Name: !Sub ${AWS::StackName}-OpenTofuRemoteBackendBucketArn

  OpenTofuRemoteBackendRegion:
    Value: !Ref AWS::Region
    Export:
      Name: !Sub ${AWS::StackName}-OpenTofuRemoteBackendRegion

  OpenTofuRemoteBackendDDBArn:
    Value: !GetAtt OpenTofuRemoteBackendDDB.Arn
    Export:
      Name: !Sub ${AWS::StackName}-OpenTofuRemoteBackendDDBArn

  GitHubOIDCProviderArn:
    Description: ARN of the GitHub OIDC Provider
    Value: !GetAtt GitHubOIDCProvider.Arn
    Export:
      Name: !Sub ${AWS::StackName}-GitHubOIDCProviderArn

  OpenTofuRemoteBackendRoleArn:
    Description: ARN of the OpenTofu Remote Backend Role
    Value: !GetAtt OpenTofuRemoteBackendRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-OpenTofuRemoteBackendRoleArn

  OpenTofuStateEncryptionRoleArn:
    Description: ARN of the OpenTofu State Encryption Role (KMS access)
    Value: !GetAtt OpenTofuStateEncryptionRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-OpenTofuStateEncryptionRoleArn

  GitRepoMgmtRoleArn:
    Description: ARN of the GitRepoMgmt Role for creating backend access roles
    Value: !GetAtt GitRepoMgmtRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-GitRepoMgmtRoleArn

  GitRepoMgmtPermissionBoundaryArn:
    Description: ARN of the Permission Boundary for roles created by git-repo-mgmt
    Value: !Ref GitRepoMgmtPermissionBoundary
    Export:
      Name: !Sub ${AWS::StackName}-GitRepoMgmtPermissionBoundaryArn

  OrganizationId:
    Description: AWS Organizations ID used for cross-account access
    Value: !Ref OrganizationId
    Export:
      Name: !Sub ${AWS::StackName}-OrganizationId
