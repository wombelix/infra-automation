# SPDX-FileCopyrightText: 2025 Dominik Wombacher <dominik@wombacher.cc>
#
# SPDX-License-Identifier: MIT

AWSTemplateFormatVersion: '2010-09-09'
Description: "Bootstrap OIDC, Roles and Policies for IaC"

Parameters:
  IACOpenTofuStackName:
    Type: String
  AWSAccountId:
    Type: String
    Description: AWS Account ID for SSO group ARN construction
    AllowedPattern: '^[0-9]{12}$'
    ConstraintDescription: Must be a valid 12-digit AWS Account ID
  IdentityCenterInstanceArn:
    Type: String
    Description: AWS Identity Center Instance ARN

Resources:
  # https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services
  GitHubOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: https://token.actions.githubusercontent.com
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - 7560D6F40FA55195F740EE2B1B7C0B4836CBE103

  OpenTofuAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: OpenTofuGitHubActionsRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Federated: !GetAtt GitHubOIDCProvider.Arn
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
                token.actions.githubusercontent.com:sub: repo:wombelix/infra-automation:ref:refs/heads/main
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWSAccountId}:role/aws-reserved/sso.amazonaws.com/${IdentityCenterInstanceArn}/AWSReservedSSO_AdministratorAccess_*"
            Action: sts:AssumeRole

  OpenTofuAccessRolePolicy:
    Type: AWS::IAM::RolePolicy
    Properties:
      RoleName: !Ref OpenTofuAccessRole
      PolicyName: OpenTofuAccessPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action: 's3:ListBucket'
            Resource:
              - Fn::ImportValue:
                  !Sub ${IACOpenTofuStackName}-OpenTofuBackendBucketArn
          - Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
            Resource:
              - Fn::Sub:
                - "${BucketArn}/opentofu-states/*"
                - BucketArn:
                    Fn::ImportValue:
                      !Sub ${IACOpenTofuStackName}-OpenTofuBackendBucketArn
          - Effect: Allow
            Action:
              - dynamodb:DescribeTable
              - dynamodb:GetItem
              - dynamodb:PutItem
              - dynamodb:DeleteItem
            Resource:
              - Fn::ImportValue:
                  !Sub ${IACOpenTofuStackName}-OpenTofuBackendDynamoDBArn
          - Effect: Allow
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource:
              - Fn::ImportValue:
                  !Sub ${IACOpenTofuStackName}-KMSKeyBackendEncryptionArn



Outputs:
  GitHubOIDCProviderArn:
    Description: ARN of the GitHub OIDC Provider
    Value: !GetAtt GitHubOIDCProvider.Arn
    Export:
      Name: !Sub "${AWS::StackName}-GitHubOIDCProvider-Arn"

  OpenTofuAccessRoleArn:
    Description: ARN of the OpenTofu Access Role
    Value: !GetAtt OpenTofuAccessRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-OpenTofuAccessRole-Arn"
